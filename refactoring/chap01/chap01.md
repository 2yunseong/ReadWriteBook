# 리팩터링: 첫번째 예시

### 예시 프로그램을 본 소감

설계가 나쁜 시스템은 수정하기 어렵다.

**프로그램이 새로운 기능을 추가하기에 편한 구조가 아니라면, 먼저 기능을 추가하기 쉬운 형태로 리팩터링하고 나서 원하는 기능을 추가한다.**

추후 사용자의 입맛에 맞게 수정할 부분이 있다면?

1. 연극부원들이 사극, 전원극, 등 다양한 연기를 하고 싶다면?
    - 적립포인트 계산법 수정 되어야 함
    - switch 문 수정되어야 한다.

### 리팩터링의 첫 단계
리팩터링의 첫 단계는 항상 똑같다. 리팩터링할 코드 영역을 꼼꼼하게 검사해줄 테스트 코드들 부터 마련해야 한다.

리팩터링에서 테스트의 역할을 굉장히 중요하다.

예제에서 `statement()` 테스트는 어떻게 구성하면 될까?

이 함수가 문자열을 반환하므로, 다양한 장르의 공연들로 구성된 공연료 청구서 몇 개를 미리 작성하여 실행할 수 있도록 설정한다.(테스트 프레임워크 이용)

테스트 결과는 자가 진단이 가능하게 설정

*리팩터링하기 전에 제대로 된 테스트부터 마련한다. 테스트는 반드시 자가진단 하도록 만든다.*

### statement() 함수 쪼개기

1. 전체 메서드의 동작을 각각의 부분으로 나눌 수 있는 지점을 찾는다.
   - 코드를 분석해야만 무엇을 하는 코드인지 아는 코드
2. 분리하려는 코드가 하는 일에 걸맞는 이름 지어주기
3. 별도 함수로 빼냈을 때 유효 범위를 벗어나는 변수가 있는지 확인
    - 변경 되지 않는 값은 매개변수로 전달
    - 값이 바뀌는 변수는 조심해서 다뤄야 한다.
4. **추출하고 나면 지금보다 명확하게 표현할 수 있는 간단한 방법은 없는지 검토.**


수정하면 곧바로 컴파일 -> 테스트 하며 실수한게 없는지 확인
- 한가지를 수정할 때 마다 테스트 하면 변경 폭이 작아 살펴볼 범위도 좁아 문제를 찾고 해결하기 용이하다.
- **조금씩 변경하고 매번 테스트하는 것은 리팩터링 절차의 핵심**
- 저자는 하나의 리팩터링을 문제없이 끝낼 때마다 커밋한다. -> 중간에 문제가 생기더라도 쉽게 돌아갈 수 있기 때문.
- 이런 자잘한 변경들이 어느새 의미 있는 단위로 뭉쳐지면 공유 저장소로 Push.

*리팩터링은 프로그램 수정을 작은 단계로 나눠 진행한다. 그래서 중간에 실수하더라도 버그를 쉽게 찾을 수 있다.*

### 임시변수 제거하기
임시변수들 때문에 로컬 범위에 존재하는 이름이 늘어나서 추출 작업이 복잡해진다.

임시변수는 나중에 문제를 일으킬 수 있다. 임시 변수는 자신이 속한 루틴에서만 의미가 있어서 루틴이 길고 복잡해지기 쉽다.

이를 제거하기 위한 한 가지 방법은 임시 변수를 질의 함수로 바꾸는 것이다.

> 질의 함수란 ? 연산을 통해 답을 구하는 행위

#### 변수 인라인 하기

질의 함수를 인라인 한다. 임시변수를 제거하고 위에서 만든 질의 함수를 이용해 인라인.

#### format 변수 제거하기
format은 임시변수에 함수를 대입한 형태인데, 이를 함수로 바꾸어서 직접 선언해 바꾸어 주자.

그런데 format이란 이름은 **함수가 하는 일을 충분히 설명하지 못한다.**

이 함수의 핵심(화폐 단위 맞추기)을 파악해, 그 느낌을 살리는 이름을 골라 **함수 선언 바꾸기**를 적용하자.

이름짓기는 중요하면서도 쉽지 않은 작업이다. 

긴 함수를 작게 쪼개는 리팩터링은 이름을 잘 지어야만 효과가 있다.

이름이 좋으면 함수 본문을 읽지 않고도 무슨 일을 하는지 알 수 있다.

물론 단번에 좋은 이름을 짓기는 쉽지 않다.

> 따라서, 처음에는 당장 떠오르는 최선의 이름을 사용하다, 나중에 더 좋은 이름이 떠오를 때 바꾸는 식이 좋다. 흔히 코드를 두 번 이상 읽고 나서야 가장 적합한 이름이 떠오르곤 한다.

### 반복문 쪼개기

반복문 하나에서 두 가지 일을 수행하는 모습을 보게 된다. (8.7 참고)

이렇게 하면 반복문을 수정해야 할 때 마다 두 가지 일 모두를 잘 이해하고 진행해야 한다.(이는 코드 이해는 번거롭게 할 것이다.)

따라서 해당 로직을 분리해서 작성하자.

무엇보다도 반복문을 쪼개서 성능이 느려지지 않을까 걱정할 수 있다.

이처럼 반복문이 중복되는 것을 꺼리는 이들이 많지만, 이 정도 중복은 성능에 미치는 영향이 미미할 때가 많다.

(실제로 실행시간에 별 차이가 없음. 중첩이 아니라면 시간복잡도가 어차피 같은 N이다.)

_리팩터링으로 인한 성능 문제는 특별한 경우가 아니라면 일단 무시하라._

-> 리팩터링 때문에 성능이 떨어진다면, 하던 리팩터링을 마무리하고 나서 성능을 개선하자. 

**잘 다듬어진 코드가 성능 개선 작업도 훨씬 수월하기 때문이다.**

#### 반복문 쪼개는 방법 
1. 반복문이 하는 일이 두 가지 이상 일 경우, 분리하자.
2. 변수 초기화 문장을 변수 값 누적 코드 바로 앞으로 옮긴다.
3. 한가지 로직을 수행할 수 있도록 분리한다.
4. 별도 함수로 추출한다.
5. 임시 변수를 질의함수로 바꾼다.
6. 변수를 인라인한다.



